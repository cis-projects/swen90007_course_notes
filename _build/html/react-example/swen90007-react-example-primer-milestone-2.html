

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Milestone 2: Core Functionality &#8212; SWEN90007 Software Design and Architecture Course Notes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'react-example/swen90007-react-example-primer-milestone-2';</script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Milestone 3: Authentication" href="swen90007-react-example-primer-milestone-3.html" />
    <link rel="prev" title="Milestone 1: Deployment" href="swen90007-react-example-primer-milestone-1.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../introduction/introduction.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../introduction/introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Workshops</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../workshops/workshop_1.html">Workshop 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workshops/workshop_2.html">Workshop 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workshops/workshop_3.html">Workshop 3</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">JSP Project Development Setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/1_intellij_install.html">Step 1: Install IntelliJ Professional Edition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/2_tomcat_download.html">Step 2: Download Tomcat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/3_postgresql_setup.html">Step 3: Setup PostgreSQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/4_create_project.html">Step 4: Create Project in IntelliJ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/5_github_setup.html">Step 5: Setup GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/6_github_clone.html">Step 6: Clone GitHub Repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/7_connect_intellij_postgresql.html">Step 7: Connect IntelliJ Project to Local PostgreSQL Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/8_setup_docker.html">Step 8: Setup Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_dev/9_render_deploy.html">Step 9: Deploy to Render</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">React Project Development Setup</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="swen90007-react-example-primer.html">React Example Project Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="swen90007-react-example-primer-milestone--1.html">Milestone -1: Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="swen90007-react-example-primer-milestone-0.html">Milestone 0: Hello World</a></li>
<li class="toctree-l1"><a class="reference internal" href="swen90007-react-example-primer-milestone-1.html">Milestone 1: Deployment</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Milestone 2: Core Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="swen90007-react-example-primer-milestone-3.html">Milestone 3: Authentication</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cis-projects/swen90007_course_notes" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cis-projects/swen90007_course_notes/issues/new?title=Issue%20on%20page%20%2Freact-example/swen90007-react-example-primer-milestone-2.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/react-example/swen90007-react-example-primer-milestone-2.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Milestone 2: Core Functionality</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#database-schema-changes">Database schema changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-changes">API changes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-json">Working with JSON</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-domain">A simple domain</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-layer">Data layer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#api-layer-and-servlets">API layer and Servlets</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#some-house-keeping">Some house keeping</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-utilities">A few utilities</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#servlet-context">Servlet Context</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-servlets-finally">The Servlets, finally</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#security-updates">Security updates</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cors">CORS</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-site-request-forgery-csrf">Cross Site Request Forgery (CSRF)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-the-api-with-httpie">Verifying the API with HTTPie</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verdict">/verdict</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#vote">/vote</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manage-vote">/manage/vote</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-the-ui">Extending the UI</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-api-client">An API client</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managing-state-with-react-contexts">Managing state with React Contexts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-pages">Routing pages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-useeffect-hook">The <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#css-modules">CSS Modules</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-again">Deployment, again</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#database">Database</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#api-and-ui">API and UI</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="milestone-2-core-functionality">
<h1>Milestone 2: Core Functionality<a class="headerlink" href="#milestone-2-core-functionality" title="Permalink to this heading">#</a></h1>
<p>By the end of this milestone we will have:</p>
<ul class="simple">
<li><p>core functionality for the system implemented</p></li>
<li><p>the system deployed to, and running on, Render’s unified cloud</p></li>
</ul>
<div class="caution admonition">
<p class="admonition-title">Skipping milestones</p>
<p>This milestone builds upon the implementation contributed by previous milestones, if you’ve skipped those previous milestones, ensure that:</p>
<ul class="simple">
<li><p>your development environment is set up appropriately, as demonstrated in <em>Milestone -1: Tools</em></p></li>
<li><p>you have an appropriately set up PostgreSQL server running locally, with a database and user configured appropriately, as demonstrated in <em>Milestone 0: Hello world</em></p></li>
<li><p>you’ve checked out the source code contributed by <em>Milestone 1: Deployment</em></p></li>
</ul>
</div>
<section id="database-schema-changes">
<h2>Database schema changes<a class="headerlink" href="#database-schema-changes" title="Permalink to this heading">#</a></h2>
<p>The system we’re building needs to be able to manage votes, however at the moment all the system does is serve dummy data. We’ll need to make a few changes to our database so that it’s able to store votes. But first, we’ll spend a moment crafting a cleanup script, which comes in handy if we ever want to purge our database of test data. Add the following SQL to a  <code class="docutils literal notranslate"><span class="pre">drop.sql</span></code> file, and run it against your database to blow away our current dummy schema.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="p">;</span><span class="w">  </span>
<span class="k">DROP</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">;</span><span class="w">  </span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p>Now that we’re working with a clean database let’s extend our current <code class="docutils literal notranslate"><span class="pre">init.db</span></code> script</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="p">;</span><span class="w">  </span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="k">AUTHORIZATION</span><span class="w"> </span><span class="n">swen90007_react_example_owner</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">vote</span><span class="w"> </span><span class="p">(</span><span class="w">  </span>
<span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span><span class="w">  </span>
<span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="w">  </span>
<span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span>
<span class="w"> </span><span class="n">supporting</span><span class="w"> </span><span class="n">bool</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span>
<span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span>
<span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="k">timestamp</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="k">zone</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">  </span>
<span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">  </span>
<span class="p">);</span><span class="w">  </span>
<span class="w">  </span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">vote_is_supporting</span><span class="w">  </span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">vote</span><span class="w"> </span><span class="p">(</span><span class="n">supporting</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
<p>We’ll also populate a the database with a little dummy data to play with, make the following changes to <code class="docutils literal notranslate"><span class="pre">load.sql</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">BEGIN</span><span class="p">;</span><span class="w">  </span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="n">vote</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">supporting</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">created</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w">  </span>
<span class="w">    </span><span class="p">(</span><span class="n">gen_random_uuid</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;Pepe Roni&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pepe.roni@pie.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;UNVERIFIED&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">()),</span><span class="w">  </span>
<span class="w">    </span><span class="p">(</span><span class="n">gen_random_uuid</span><span class="p">(),</span><span class="w"> </span><span class="s1">&#39;Barbie Queue&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b.queue@slice.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;UNVERIFIED&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">());</span><span class="w">  </span>
<span class="k">COMMIT</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="api-changes">
<h2>API changes<a class="headerlink" href="#api-changes" title="Permalink to this heading">#</a></h2>
<p>We’ll need to extend the current API so that it can serve votes and the current verdict.</p>
<div class="caution admonition">
<p class="admonition-title">Purpose of this example</p>
<p>Please be aware that the purpose of this example is to introduce you to working with React, <em>not</em> to provide an example implementation of the various patterns covered in this course. Beware that the API implementation discussed in this section does not make use of many of the patterns that you are required to engage with in this subject.</p>
</div>
<section id="working-with-json">
<h3>Working with JSON<a class="headerlink" href="#working-with-json" title="Permalink to this heading">#</a></h3>
<p>Our API will utilise JavaScript Object Notation (JSON) as a <em>data transfer format</em>, thus we’ll need to marshal and unmarshal Java objects to and from JSON. JSON is relatively complicated - to build your own JSON parsing would be a fairly significant undertaking, and complete waste of time - so we’ll make use of one of the more popular libraries <a class="reference external" href="https://github.com/FasterXML/jackson">Jackson</a>. Include the following coordinates in you Maven configuration (<code class="docutils literal notranslate"><span class="pre">pom.xml</span></code>).</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;properties&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;jackson.version&gt;</span>2.14.2<span class="nt">&lt;/jackson.version&gt;</span><span class="w">   </span>
<span class="nt">&lt;/properties&gt;</span>

<span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span><span class="w">  </span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span><span class="w">  </span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span><span class="w">  </span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>${jackson.version}<span class="nt">&lt;/version&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>jackson-datatype-jsr310<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>${jackson.version}<span class="nt">&lt;/version&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
</section>
<section id="a-simple-domain">
<h3>A simple domain<a class="headerlink" href="#a-simple-domain" title="Permalink to this heading">#</a></h3>
<p>We’ll implement a very simple domain, we’ll create - amongst others - a <code class="docutils literal notranslate"><span class="pre">Vote</span></code> and <code class="docutils literal notranslate"><span class="pre">Verdict</span></code> class. See the <code class="docutils literal notranslate"><span class="pre">Vote</span></code> class below:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.annotation.JsonIgnore</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.OffsetDateTime</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Vote</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">supporting</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OffsetDateTime</span><span class="w"> </span><span class="n">created</span><span class="p">;</span><span class="w"> </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">   </span>
<span class="w">  </span>
<span class="w">    </span><span class="c1">// accessors, omitted for brevity ... </span>

<span class="w">    </span><span class="nd">@JsonIgnore</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isNew</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_new</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span>
<span class="w">    </span><span class="nd">@JsonIgnore</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setNew</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">_new</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">_new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_new</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">Status</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">UNVERIFIED</span><span class="p">,</span><span class="w">  </span>
<span class="w">        </span><span class="n">ACCEPTED</span><span class="p">,</span><span class="w">  </span>
<span class="w">        </span><span class="n">REJECTED</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>There’s a few things to note in the above:</p>
<ol class="arabic simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">Status</span></code> enum is implemented as a static inner enum of the <code class="docutils literal notranslate"><span class="pre">Vote</span></code> class, as it’ll never be referred to outside this vote context</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">_new</span></code> field will be used by our database mapping code to decide if a vote has just been created or updated.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">_new</span></code> field will be purely internal, so we’ll hide it from API consumers by annotating its accessors with the Jackson annotation <code class="docutils literal notranslate"><span class="pre">&#64;JsonIgnore</span></code> - this will ensure that the Jackson library won’t marshal this field as a JSON attribute.</p></li>
</ol>
<p>We’ll also implement a <code class="docutils literal notranslate"><span class="pre">VoteService</span></code> class that abstracts the complexity of working with the domain from the Servlet implementations - which we’d rather just focus on working with JSON and handling errors.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.OffsetDateTime</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.regex.Pattern</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VoteService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="n">EMAIL_PATTERN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pattern</span><span class="p">.</span><span class="na">compile</span><span class="p">(</span><span class="s">&quot;^[a-zA-Z0-9.!#$%&amp;&#39;*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)*$&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">VoteRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="c1">// constructors, omitted for brevity</span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">submit</span><span class="p">(</span><span class="n">NewVoteRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValidationException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;email is required&quot;</span>
<span class="w">            </span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isEmailValid</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getEmail</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ValidationException</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;email must be a valid email&quot;</span>
<span class="w">            </span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Vote</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setEmail</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getEmail</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setSupporting</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">isSupporting</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">Vote</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">UNVERIFIED</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setCreated</span><span class="p">(</span><span class="n">OffsetDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="n">repository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">vote</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vote</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Verdict</span><span class="w"> </span><span class="nf">calculateVerdict</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">votes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">getValid</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">supporting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">votes</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">Vote</span><span class="p">::</span><span class="n">isSupporting</span><span class="p">)</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">count</span><span class="p">();</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Verdict</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="n">supporting</span><span class="p">,</span><span class="w">  </span>
<span class="w">                </span><span class="n">votes</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">supporting</span><span class="w">  </span>
<span class="w">        </span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Vote</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllVotes</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity</span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">updateVote</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">UpdateVoteRequest</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isEmailValid</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EMAIL_PATTERN</span><span class="p">.</span><span class="na">matcher</span><span class="p">(</span><span class="n">email</span><span class="p">).</span><span class="na">find</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>Some of the service implementation above has been excluded for brevity, however what’s included illustrates a few key principals:</p>
<ol class="arabic simple">
<li><p>the service exposes core functionality of the domain, via methods such as <code class="docutils literal notranslate"><span class="pre">submit</span></code> and <code class="docutils literal notranslate"><span class="pre">calculateVerdict</span></code></p></li>
<li><p>the service is responsible for validating inputs, for example <code class="docutils literal notranslate"><span class="pre">isEmailValid</span></code></p></li>
<li><p>the service is additionally responsible for enforcing key business rules, such as calculating the verdict</p></li>
<li><p>to keep the service lean we’ll delegate the complexity of working with the database to a <code class="docutils literal notranslate"><span class="pre">VoteRepository</span></code>, on which the service will depend</p></li>
</ol>
<div class="note admonition">
<p class="admonition-title">Java validation</p>
<p>The validation carried out for this domain is rather limited, and so the naive approach of hardcoding this validation is acceptable. For complicated domains a more scalable, elegant solution is often required. One such solution is the <a class="reference external" href="https://beanvalidation.org/">Jakarta Bean Validation</a> specification, which provides a suite of Java annotations that can be applied to classes, fields, methods and parameters to hint to validator implementations (such as the <a class="reference external" href="https://hibernate.org/validator/">Hibernate Validator</a>) which constraints are to be applied. For example, consider the following class:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">ToBeValidated</span><span class="w"> </span><span class="p">{</span>

<span class="w"> </span><span class="nd">@NotNull</span>
<span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w"> </span>
<span class="w"> </span><span class="c1">// constructors and accessors, omitted for brevity ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following code will throw an error - the validator detects that the value of the <code class="docutils literal notranslate"><span class="pre">value</span></code> field is <code class="docutils literal notranslate"><span class="pre">null</span></code>:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ToBeValidated</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Validation</span><span class="p">.</span><span class="na">buildDefaultValidatorFactory</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="n">validator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="na">getValidator</span><span class="p">();</span>
<span class="n">validator</span><span class="p">.</span><span class="na">validate</span><span class="p">(</span><span class="n">invalid</span><span class="p">);</span>
</pre></div>
</div>
</div>
</section>
<section id="data-layer">
<h3>Data layer<a class="headerlink" href="#data-layer" title="Permalink to this heading">#</a></h3>
<p>Creating a database connection is expensive, and this expense adds up if our API is to be called often. To avoid the overhead involved in creating connections we’ll implement a very simple connection pool.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.port.postgres</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.Connection</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.DriverManager</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.SQLException</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.BlockingDeque</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.LinkedBlockingDeque</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConnectionProvider</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MAX_CONNECTIONS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">ACQUIRE_CONNECTION_TIMEOUT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BlockingDeque</span><span class="o">&lt;</span><span class="n">Connection</span><span class="o">&gt;</span><span class="w"> </span><span class="n">connectionPool</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ConnectionProvider</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">;</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">username</span><span class="p">;</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">password</span><span class="p">;</span><span class="w">  </span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">connectionPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">connectionPool</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_CONNECTIONS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">connectionPool</span><span class="p">.</span><span class="na">offer</span><span class="p">(</span><span class="n">connect</span><span class="p">());</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="n">Connection</span><span class="w"> </span><span class="nf">nextConnection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">connectionPool</span><span class="p">.</span><span class="na">poll</span><span class="p">(</span><span class="n">ACQUIRE_CONNECTION_TIMEOUT</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">releaseConnection</span><span class="p">(</span><span class="n">Connection</span><span class="w"> </span><span class="n">connection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">connectionPool</span><span class="p">.</span><span class="na">offer</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span><span class="w"> </span><span class="n">ACQUIRE_CONNECTION_TIMEOUT</span><span class="p">.</span><span class="na">toMillis</span><span class="p">(),</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="nf">connect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">DriverManager</span><span class="p">.</span><span class="na">getConnection</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>There’s perhaps less happening here than might first appear:</p>
<ol class="arabic simple">
<li><p>internally the pool uses a <code class="docutils literal notranslate"><span class="pre">BlockingDeque</span></code>, which avoids the need for us to write any of our own concurrency handling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">init</span></code> sets up our pool of connections, our application code will need to invoke this on startup</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nextConnection</span></code> removes and returns a connection from the pool, blocking until one is available - or throwing if a timeout is reached</p></li>
<li><p>conversely <code class="docutils literal notranslate"><span class="pre">releaseConnection</span></code> returns a connection to the pool, we’ll need to be sure that our application code does so when it’s finished processing a request</p></li>
</ol>
<p>The data layer will map rows in the database to entities within the domain. Because the domain is so simple, we’ll only need one vote mapper, the <code class="docutils literal notranslate"><span class="pre">VoteRepositoryImpl</span></code> class.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.port.postgres</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain.Vote</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain.VoteRepository</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.PreparedStatement</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.ResultSet</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.sql.SQLException</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.time.OffsetDateTime</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.ArrayList</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PostgresVoteRepository</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">VoteRepository</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConnectionProvider</span><span class="w"> </span><span class="n">connectionProvider</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// construtors, omitted for brevity</span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Vote</span><span class="w"> </span><span class="n">vote</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vote</span><span class="p">.</span><span class="na">isNew</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">vote</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">update</span><span class="p">(</span><span class="n">vote</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">insert</span><span class="p">(</span><span class="n">Vote</span><span class="w"> </span><span class="n">vote</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connectionProvider</span><span class="p">.</span><span class="na">nextConnection</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">PreparedStatement</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connection</span><span class="p">.</span><span class="na">prepareStatement</span><span class="p">(</span><span class="w">  </span>
<span class="w">                    </span><span class="s">&quot;INSERT INTO vote (id, name, email, supporting, status, created) VALUES (?, ?, ?, ?, ?, ?)&quot;</span><span class="w">  </span>
<span class="w">            </span><span class="p">);</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setObject</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">fromString</span><span class="p">(</span><span class="n">vote</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span><span class="p">.</span><span class="na">getEmail</span><span class="p">());</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setBoolean</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span><span class="p">.</span><span class="na">isSupporting</span><span class="p">());</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setString</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">name</span><span class="p">());</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">setObject</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span><span class="p">.</span><span class="na">getCreated</span><span class="p">());</span><span class="w">  </span>
<span class="w">            </span><span class="n">statement</span><span class="p">.</span><span class="na">execute</span><span class="p">();</span><span class="w">    </span>
<span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">SQLException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;failed to insert new vote: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="n">vote</span><span class="p">.</span><span class="na">setNew</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span><span class="n">connectionProvider</span><span class="p">.</span><span class="na">releaseConnection</span><span class="p">(</span><span class="n">connection</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vote</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="n">Vote</span><span class="w"> </span><span class="n">vote</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Vote</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Vote</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getValid</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Vote</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAll</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// implementation, omitted for brevity     </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Vote</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">ResultSet</span><span class="w"> </span><span class="n">resultSet</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">SQLException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Vote</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setNew</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setEmail</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;email&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setSupporting</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getBoolean</span><span class="p">(</span><span class="s">&quot;supporting&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="n">Vote</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;status&quot;</span><span class="p">)));</span><span class="w">  </span>
<span class="w">        </span><span class="n">vote</span><span class="p">.</span><span class="na">setCreated</span><span class="p">(</span><span class="n">resultSet</span><span class="p">.</span><span class="na">getObject</span><span class="p">(</span><span class="s">&quot;created&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetDateTime</span><span class="p">.</span><span class="na">class</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">vote</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>The mapping is not terribly complicated:</p>
<ol class="arabic simple">
<li><p>We’ll delegate management of connections to the <code class="docutils literal notranslate"><span class="pre">ConnectionProvider</span></code> we just implemented, when the mapper requires a connection it simply asks for one, and releases it back to the pool when it’s done.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save</span></code> makes use of <code class="docutils literal notranslate"><span class="pre">Vote#isNew</span></code> to determine if data for the vote instance should be inserted as a new row, or should be used to update an existing row. Our mapping code makes sure to set <code class="docutils literal notranslate"><span class="pre">Vote#isNew</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code> when returning data from the database.</p></li>
<li><p>many of the methods, such as <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">getValid</span></code>, map row data to instances of a <code class="docutils literal notranslate"><span class="pre">Vote</span></code> class, we’ll observe DRY by refactoring this mapping code into its own private method <code class="docutils literal notranslate"><span class="pre">map</span></code></p></li>
</ol>
</section>
<section id="api-layer-and-servlets">
<h3>API layer and Servlets<a class="headerlink" href="#api-layer-and-servlets" title="Permalink to this heading">#</a></h3>
<section id="some-house-keeping">
<h4>Some house keeping<a class="headerlink" href="#some-house-keeping" title="Permalink to this heading">#</a></h4>
<p>We can now implement the various Servlets that will expose our domain as an API. Let’s clean up a little first by removing the existing <code class="docutils literal notranslate"><span class="pre">TestResource</span></code>, which we won’t need anymore.</p>
</section>
<section id="a-few-utilities">
<h4>A few utilities<a class="headerlink" href="#a-few-utilities" title="Permalink to this heading">#</a></h4>
<p>Two of the key responsibilities of the API layer will be working with JSON and handling errors from the domain. To simplify our Servlet implementations we’ll delegate as much JSON and error handling as is sensible to a number of shared utility classes.</p>
<p>For each request, we’ll likely need to return a response, which will involve - at the very least - setting a status on the response and marshalling an object to a JSON response body. We’ll use a <code class="docutils literal notranslate"><span class="pre">ResponseEntity</span></code> class to unify returning data to the UI, and an implementation of a <code class="docutils literal notranslate"><span class="pre">RequestHandler</span></code> interface - <code class="docutils literal notranslate"><span class="pre">MarshallingRequestHandler</span></code> - to unify how we marshal domain objects to JSON.</p>
<p>We’ll need to return errors if things don’t quite work out within the domain. We’ll use the <code class="docutils literal notranslate"><span class="pre">Error</span></code> class to unify how we serve an error response, and the <code class="docutils literal notranslate"><span class="pre">ErrorHandler</span></code> to convert thrown exceptions to an appropriate error response.</p>
</section>
<section id="servlet-context">
<h4>Servlet Context<a class="headerlink" href="#servlet-context" title="Permalink to this heading">#</a></h4>
<p>In this project we’re observing the <em>Inversion of Control</em> (IoC) pattern, and without a <em>Dependency Injection</em> framework with which to implement Inversion of Control we’re left with the responsibility of managing the dependencies of all our components explicitly - that is, we will need to, (by-hand) build up our application by instantiating each component and providing each with the various specific implementations on which it should depend. We’ll use an implementation of the <code class="docutils literal notranslate"><span class="pre">ServletContextListener</span></code> class as an entry-point for instantiating the key components of our system.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.api</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.annotation.JsonInclude</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.SerializationFeature</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.datatype.jsr310.JavaTimeModule</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain.VoteService</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.port.postgres.ConnectionProvider</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.port.postgres.PostgresVoteRepository</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.ServletContextEvent</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.ServletContextListener</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.annotation.WebListener</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">org.springframework.http.converter.json.Jackson2ObjectMapperBuilder</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="nd">@WebListener</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VoteContextListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ServletContextListener</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">VOTE_SERVICE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;voteService&quot;</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MAPPER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mapper&quot;</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">contextInitialized</span><span class="p">(</span><span class="n">ServletContextEvent</span><span class="w"> </span><span class="n">sce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">connectionProvider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConnectionProvider</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&quot;postgres.url&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&quot;postgres.username&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&quot;postgres.password&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">        </span><span class="n">connectionProvider</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="n">sce</span><span class="p">.</span><span class="na">getServletContext</span><span class="p">().</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">VOTE_SERVICE</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VoteService</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PostgresVoteRepository</span><span class="p">(</span><span class="n">connectionProvider</span><span class="p">)));</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Jackson2ObjectMapperBuilder</span><span class="p">.</span><span class="na">json</span><span class="p">()</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">modules</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">JavaTimeModule</span><span class="p">())</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">failOnUnknownProperties</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">serializationInclusion</span><span class="p">(</span><span class="n">JsonInclude</span><span class="p">.</span><span class="na">Include</span><span class="p">.</span><span class="na">NON_EMPTY</span><span class="p">)</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">        </span><span class="n">mapper</span><span class="p">.</span><span class="na">configure</span><span class="p">(</span><span class="n">SerializationFeature</span><span class="p">.</span><span class="na">WRITE_DATES_AS_TIMESTAMPS</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">        </span><span class="n">sce</span><span class="p">.</span><span class="na">getServletContext</span><span class="p">().</span><span class="na">setAttribute</span><span class="p">(</span><span class="n">MAPPER</span><span class="p">,</span><span class="w"> </span><span class="n">mapper</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">ServletContextListener</span><span class="p">.</span><span class="na">super</span><span class="p">.</span><span class="na">contextInitialized</span><span class="p">(</span><span class="n">sce</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">contextDestroyed</span><span class="p">(</span><span class="n">ServletContextEvent</span><span class="w"> </span><span class="n">sce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">ServletContextListener</span><span class="p">.</span><span class="na">super</span><span class="p">.</span><span class="na">contextDestroyed</span><span class="p">(</span><span class="n">sce</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>The class above performs a number of key tasks:</p>
<ol class="arabic simple">
<li><p>the listener instantiates a number of shared resources or services - such as, the object mapper that Servlets use to manage JSON, our specific PostgreSQL implementation of the <code class="docutils literal notranslate"><span class="pre">VoteRepository</span></code> interface (and in the process, instantiate, and initialise, the connection pool on which it depends), and the services that provide a facade to the domain itself.</p></li>
<li><p>the listener registers each of these shared resources with the Servlet Context so that they can be discovered and used by Servlets servicing requests to the API</p></li>
</ol>
</section>
<section id="the-servlets-finally">
<h4>The Servlets, finally<a class="headerlink" href="#the-servlets-finally" title="Permalink to this heading">#</a></h4>
<p>There are a number of Servlets to implement, thankfully they’re all relatively similar so we’ll only look at one, the <code class="docutils literal notranslate"><span class="pre">VerdictResource</span></code> Servlet.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.api</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">com.unimelb.swen90007.reactexampleapi.domain.VoteService</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.ServletException</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.annotation.WebServlet</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.http.HttpServlet</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.http.HttpServletRequest</span><span class="p">;</span><span class="w">  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.servlet.http.HttpServletResponse</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="nd">@WebServlet</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;verdict&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">urlPatterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/verdict&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VerdictResource</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HttpServlet</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">VoteService</span><span class="w"> </span><span class="n">voteService</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="p">;</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doGet</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">resp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">MarshallingRequestHandler</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span><span class="w"> </span><span class="n">resp</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorHandler</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">voteService</span><span class="p">.</span><span class="na">calculateVerdict</span><span class="p">())))</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">handle</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="n">voteService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VoteService</span><span class="p">)</span><span class="w"> </span><span class="n">getServletContext</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">VoteContextListener</span><span class="p">.</span><span class="na">VOTE_SERVICE</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ObjectMapper</span><span class="p">)</span><span class="w"> </span><span class="n">getServletContext</span><span class="p">().</span><span class="na">getAttribute</span><span class="p">(</span><span class="n">VoteContextListener</span><span class="p">.</span><span class="na">MAPPER</span><span class="p">);</span><span class="w">  </span>
<span class="w">     </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
<p>The key points are:</p>
<ol class="arabic simple">
<li><p>the Servlet delegates to the <code class="docutils literal notranslate"><span class="pre">VoteService</span></code> and an <code class="docutils literal notranslate"><span class="pre">ObjectMapper</span></code>, it discovers both of these during its <code class="docutils literal notranslate"><span class="pre">init</span></code> method, via the Servlet Context .</p></li>
<li><p>the Servlet exposes only one HTTP method via an overridden <code class="docutils literal notranslate"><span class="pre">doGet</span></code> implementation. The Servlet delegates all the JSON and error handling to a number of <code class="docutils literal notranslate"><span class="pre">RequestHandler</span></code> implementations that are responsible for setting data on the <code class="docutils literal notranslate"><span class="pre">HttpServletResponse</span></code>.</p></li>
</ol>
</section>
</section>
<section id="security-updates">
<h3>Security updates<a class="headerlink" href="#security-updates" title="Permalink to this heading">#</a></h3>
<p>Our existing security configuration was appropriate for the very simple test endpoint we build in previous milestones, however we’ve now made some fairly significant changes that require a revised configuration.</p>
<section id="cors">
<h4>CORS<a class="headerlink" href="#cors" title="Permalink to this heading">#</a></h4>
<p>The current CORS configuration handles only HTTP GET methods, we’ll need to configure it to handle both POST and PUT as well.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="n">CorsConfigurationSource</span><span class="w"> </span><span class="nf">corsConfigurationSource</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">CorsConfiguration</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CorsConfiguration</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">configuration</span><span class="p">.</span><span class="na">setAllowedOrigins</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">PROPERTY_CORS_ORIGINS_UI</span><span class="p">)));</span><span class="w">  </span>
<span class="w">    </span><span class="n">configuration</span><span class="p">.</span><span class="na">setAllowedMethods</span><span class="p">(</span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;POST&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;PUT&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">    </span><span class="n">UrlBasedCorsConfigurationSource</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UrlBasedCorsConfigurationSource</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">source</span><span class="p">.</span><span class="na">registerCorsConfiguration</span><span class="p">(</span><span class="s">&quot;/**&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">configuration</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">source</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="cross-site-request-forgery-csrf">
<h4>Cross Site Request Forgery (CSRF)<a class="headerlink" href="#cross-site-request-forgery-csrf" title="Permalink to this heading">#</a></h4>
<p>Spring Security ships with CSRF protections. These protections are applied to modifying HTTP methods (POST, PUT etc), and ensure attackers can’t <em>replay</em> a user’s request (after stealing a session) by requiring that such requests are sent with a CSRF token HTTP header (set to a value that would be impossible for an attacker to discover or guess). We won’t be tackling CSRF in this milestone so we’ll just disable it for now.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Bean</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="n">SecurityFilterChain</span><span class="w"> </span><span class="nf">securityFilterChain</span><span class="p">(</span><span class="n">HttpSecurity</span><span class="w"> </span><span class="n">http</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">http</span><span class="w">  </span>
<span class="w">            </span><span class="p">.</span><span class="na">cors</span><span class="p">(</span><span class="n">Customizer</span><span class="p">.</span><span class="na">withDefaults</span><span class="p">())</span><span class="w">  </span>
<span class="w">            </span><span class="p">.</span><span class="na">csrf</span><span class="p">().</span><span class="na">disable</span><span class="p">()</span><span class="w">  </span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  </span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="verifying-the-api-with-httpie">
<h3>Verifying the API with HTTPie<a class="headerlink" href="#verifying-the-api-with-httpie" title="Permalink to this heading">#</a></h3>
<p>After spending some time studying the API source code associated with this milestone, make whatever changes you need to align your implementation so that we can begin verifying our API. We’ll conduct this verification with <a class="reference external" href="https://httpie.io/">HTTPie</a>, an excellent HTTP client and CLI tool (for those that prefer a UI, HTTPie also has a desktop application similar to Postman), find out how you can install it <a class="reference external" href="https://httpie.io/docs/cli/installation">here</a>. Once you have the HTTPie CLI installed locally let’s verify that each of our endpoints work.</p>
<section id="verdict">
<h4>/verdict<a class="headerlink" href="#verdict" title="Permalink to this heading">#</a></h4>
<p>Use HTTPie to hit the verdict endpoint</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>:8080/react_example_api_war_exploded/verdict
</pre></div>
</div>
<p>You should receive a response similar to</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>HTTP/1.1<span class="w"> </span><span class="m">200</span>
Cache-Control:<span class="w"> </span>no-cache,<span class="w"> </span>no-store,<span class="w"> </span>max-age<span class="o">=</span><span class="m">0</span>,<span class="w"> </span>must-revalidate
Connection:<span class="w"> </span>keep-alive
Content-Length:<span class="w"> </span><span class="m">29</span>
Content-Type:<span class="w"> </span>application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>UTF-8
Date:<span class="w"> </span>Mon,<span class="w"> </span><span class="m">28</span><span class="w"> </span>Aug<span class="w"> </span><span class="m">2023</span><span class="w"> </span><span class="m">10</span>:54:44<span class="w"> </span>GMT
Expires:<span class="w"> </span><span class="m">0</span>
Keep-Alive:<span class="w"> </span><span class="nv">timeout</span><span class="o">=</span><span class="m">20</span>
Pragma:<span class="w"> </span>no-cache
Vary:<span class="w"> </span>Origin
Vary:<span class="w"> </span>Access-Control-Request-Method
Vary:<span class="w"> </span>Access-Control-Request-Headers
X-Content-Type-Options:<span class="w"> </span>nosniff
X-Frame-Options:<span class="w"> </span>DENY
X-XSS-Protection:<span class="w"> </span><span class="m">0</span>

<span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;opposing&quot;</span>:<span class="w"> </span><span class="m">1</span>,
<span class="w">    </span><span class="s2">&quot;supporting&quot;</span>:<span class="w"> </span><span class="m">1</span>
<span class="o">}</span>
</pre></div>
</div>
</section>
<section id="vote">
<h4>/vote<a class="headerlink" href="#vote" title="Permalink to this heading">#</a></h4>
<p>Use HTTPie to POST a new vote</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>:8080/react_example_api_war_exploded/vote<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Testy McTestington&#39;</span><span class="w"> </span><span class="nv">email</span><span class="o">=</span><span class="s1">&#39;test@testerz.com&#39;</span><span class="w"> </span>supporting:<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>Notice that our error handling should work too - try to create a vote with an invalid email, it should respond with an error status and message.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>:8080/react_example_api_war_exploded/vote<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Bizarro Testy McTestington&#39;</span><span class="w"> </span><span class="nv">email</span><span class="o">=</span><span class="s1">&#39;not-an-email&#39;</span><span class="w"> </span>supporting:<span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
</section>
<section id="manage-vote">
<h4>/manage/vote<a class="headerlink" href="#manage-vote" title="Permalink to this heading">#</a></h4>
<p>Let’s verify that we can get all the votes</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>:8080/react_example_api_war_exploded/manage/vote
</pre></div>
</div>
<p>And update a vote too - make sure you replace <code class="docutils literal notranslate"><span class="pre">&lt;vote-id&gt;</span></code> with the ID of the vote created earlier.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>PUT<span class="w"> </span>:8080/react_example_api_war_exploded/manage/vote/&lt;vote-id&gt;<span class="w"> </span><span class="nv">name</span><span class="o">=</span><span class="s1">&#39;Testy McTestington&#39;</span><span class="w"> </span><span class="nv">email</span><span class="o">=</span><span class="s1">&#39;test@testerz.com&#39;</span><span class="w"> </span>supporting:<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="nv">status</span><span class="o">=</span>REJECTED<span class="w"> </span><span class="nv">created</span><span class="o">=</span><span class="s1">&#39;2023-08-28T11:01:56.382788Z&#39;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="extending-the-ui">
<h2>Extending the UI<a class="headerlink" href="#extending-the-ui" title="Permalink to this heading">#</a></h2>
<p>Now we come to the rather large job of building out the core functionality required of the UI.</p>
<section id="an-api-client">
<h3>An API client<a class="headerlink" href="#an-api-client" title="Permalink to this heading">#</a></h3>
<p>In the previous implementation we made fetch calls directly within our components, this is fine for simple tasks but a better approach is to delegate the complexity of dispatching calls to the API to another part of the application that can be shared across components. We’ll create <code class="docutils literal notranslate"><span class="pre">api.js</span></code> for this purpose.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">CONTENT_TYPE_APPLICATION_JSON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Api</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">baseUrl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getVerdict</span><span class="p">(</span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">doCall</span><span class="p">(</span><span class="s1">&#39;/verdict&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">submitVote</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">email</span><span class="p">,</span><span class="w"> </span><span class="nx">supporting</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// implemenation, omitted for brevity</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getVotes</span><span class="p">(</span><span class="nx">offset</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// implemenation, omitted for brevity</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">updateVote</span><span class="p">(</span><span class="nx">vote</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// implemenation, omitted for brevity</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">doCall</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">method</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">CONTENT_TYPE_APPLICATION_JSON</span><span class="p">,</span>
<span class="w">            </span><span class="nx">Accept</span><span class="o">:</span><span class="w"> </span><span class="nx">CONTENT_TYPE_APPLICATION_JSON</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">body</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span>
<span class="w">            </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">baseUrl</span><span class="si">}${</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nx">method</span><span class="p">,</span>
<span class="w">                </span><span class="nx">headers</span><span class="p">,</span>
<span class="w">                </span><span class="nx">body</span><span class="p">,</span>
<span class="w">                </span><span class="nx">signal</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">299</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`expecting success from API for </span><span class="si">${</span><span class="nx">method</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">path</span><span class="si">}</span><span class="sb"> but response was status </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Some things to note here:</p>
<ol class="arabic simple">
<li><p>each of the calls to the API are implemented as a method on the <code class="docutils literal notranslate"><span class="pre">Api</span></code> class, ie <code class="docutils literal notranslate"><span class="pre">getVerdict</span></code>, <code class="docutils literal notranslate"><span class="pre">submitVote</span></code></p></li>
<li><p>the handling for the fetch will be more or less the same for each call, so we’ll refactor this shared behaviour into the method <code class="docutils literal notranslate"><span class="pre">doCall</span></code></p></li>
<li><p>we’ll convert HTTP status codes that relate to client and server errors into JavaScript Errors that can be caught by components</p></li>
<li><p>again, we are observing IoC by providing the API’s location as a <code class="docutils literal notranslate"><span class="pre">baseUrl</span></code> attribute on which the client depends</p></li>
<li><p>you might be wondering what the <code class="docutils literal notranslate"><span class="pre">signal</span></code> parameter to each <code class="docutils literal notranslate"><span class="pre">Api</span></code> method is - we’ll cover this aspect in more detail later, but it’s enough to know, at this stage, that the <code class="docutils literal notranslate"><span class="pre">signal</span></code> parameter provides us a way to abort inflight requests</p></li>
</ol>
</section>
<section id="managing-state-with-react-contexts">
<h3>Managing state with React Contexts<a class="headerlink" href="#managing-state-with-react-contexts" title="Permalink to this heading">#</a></h3>
<p>In previous milestones we implemented application state with the <code class="docutils literal notranslate"><span class="pre">useState</span></code> hook and learnt how we can use component props to deliver state to the parts of the application that require it. These tools are perfect for managing state in a local way, and should be your first port of call when designing components. However, you may come across situations where some aspect of application state must be shared across a number of relatively unrelated components. Distributing this state, with the tools we currently know, involves identifying a common parent component to manage the shared state, and have it pass the state to it’s children - who in turn may need to pass the state to their own children, until finally the state is injected into the various components that require it. If the common parent is a distant ancestor of the components that actually require the shared state, then passing the state through the entire lineage of child components becomes an incredibly cumbersome and brittle exercise. There is, thankfully, another way.</p>
<p>React <em>Context</em> hooks provide a simple way to deliver state to parts of our application without the use of props, and thus avoid the problematic requirement that props must be passed by parent components. The API client we just implemented represents application state that we’d prefer is simply delivered to where it’s needed, it will be used by various containers that send requests to the API and marshal received data into a component hierarchy,  but also by more simple components that display dynamic data.</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createContext</span><span class="p">,</span><span class="w"> </span><span class="nx">useContext</span><span class="p">,</span><span class="w"> </span><span class="nx">useMemo</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">PropType</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;prop-types&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Api</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../api&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ApiContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createContext</span><span class="p">();</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">ApiProvider</span><span class="p">({</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useMemo</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Api</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="w">  </span><span class="nx">REACT_APP_API_BASE_URL</span><span class="p">),</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">ApiContext</span><span class="p">.</span><span class="na">Provider</span> <span class="na">value</span><span class="o">=</span><span class="p">{</span><span class="nx">api</span><span class="p">}&gt;</span>
<span class="w">            </span><span class="p">{</span><span class="nx">children</span><span class="p">}</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">ApiContext</span><span class="p">.</span><span class="na">Provider</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">useApi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">useContext</span><span class="p">(</span><span class="nx">ApiContext</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">ApiProvider</span><span class="p">.</span><span class="nx">propTypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">children</span><span class="o">:</span><span class="w"> </span><span class="nx">PropType</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The implementation of the API client context is rather simple:</p>
<ol class="arabic simple">
<li><p>we use the <code class="docutils literal notranslate"><span class="pre">createContext</span></code> function to register a new context that will hold the state</p></li>
<li><p>our <code class="docutils literal notranslate"><span class="pre">ApiProvider</span></code> component is responsible for instantiating the API client. Again, we’re externalising environmental configuration, such as the API location, with a little help from React and the way that it manages environment variables</p></li>
<li><p>we’ll make use of the <code class="docutils literal notranslate"><span class="pre">useMemo</span></code> hook to cache the API client between re-renders, because no dependencies are declared for this hook the value will never be updated - which is what we want</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ApiProvider</span></code> simply wraps its child components in a component provided by the <code class="docutils literal notranslate"><span class="pre">ApiContext</span></code>, which is responsible for exposing the cached API client.</p></li>
<li><p>because we are no longer passing the API client as props, child components need another way to reference the client. The way to do this is via <code class="docutils literal notranslate"><span class="pre">useContext</span></code> - to encapsulate our context a little we’ll avoid clients depending on this method (and access to <code class="docutils literal notranslate"><span class="pre">ApiContext</span></code>) by providing a convenience method <code class="docutils literal notranslate"><span class="pre">useApi</span></code>.</p></li>
</ol>
<p>Great, now we have a Context that exposes the API client to any part of the application that requires it - but, how do we use it?</p>
<p>First, we need to add the Context to our application, it should wrap any components that require access to the API client.</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;./App.css&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ApiProvider</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./contexts/ApiProvider&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;App&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">header</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;App-header&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">ApiProvider</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="c1">// other components, for example the</span>
<span class="w">                    </span><span class="c1">// the Verdict component below</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">ApiProvider</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">App</span><span class="p">;</span>
</pre></div>
</div>
<p>Then consider a stripped down version of the Verdict container:</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useApi</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../contexts/ApiProvider&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Verdict</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useApi</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">    </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">doFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">api</span><span class="p">.</span><span class="nx">getVerdict</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">doFetch</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="c1">// some beautiful JSX</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above illustrates:</p>
<ol class="arabic simple">
<li><p>we can inject the API client by importing and invoking the <code class="docutils literal notranslate"><span class="pre">useApi</span></code> method from previous</p></li>
<li><p>the api can be referenced through out the component, we’re making use of the <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook to fetch the verdict when the Verdict container is mounted to the DOM</p></li>
<li><p>there is no need for props here, we don’t require a common parent to provide the API client, instead the Verdict component fetches the client itself</p></li>
</ol>
</section>
<section id="routing-pages">
<h3>Routing pages<a class="headerlink" href="#routing-pages" title="Permalink to this heading">#</a></h3>
<p>Let’s take a step back and consider the requirements for this application, we need to implement three core use cases.</p>
<ul class="simple">
<li><p>all users can view the current verdict</p></li>
<li><p>these same users can submit votes</p></li>
<li><p>and admins require the ability to manage submitted votes</p></li>
</ul>
<p>We’ll implement a page for each of these core use cases, via which the relevant users can achieve their goals - and to do that we’ll need to both enable and configure routing.</p>
<div class="note admonition">
<p class="admonition-title">Routing in an Single Page Application</p>
<p>You might be wondering why we’re talking about routing with respect to developing Single Page Applications - isn’t there just one, <em>Single</em> page, is that not the point of an SPA? The answer to that is rather involved, and requires a lengthy treatment of the purpose and history of the URL - however, the short version is that URLs are useful, it’s convenient for me to provide you a URL to, say, the verdict page of the application, or if you are a new administrator I might like to provide you a link to the admin dashboard instead. Without routing I can only provided you a link to the application itself - if you’re that new administrator you’ll have to figure out how to get to the admin dashboard yourself (bad luck!). Traditionally, URLs locate documents on a server; however, within the context of SPAs, routing provides us a way to translate a URL into a particular DOM state - for example the DOM for the admin dashboard. So SPA do have pages, just not in the traditional sense. The <em>Single</em> in SPA actually refers to how the application is delivered to the client, it’s served as single document - a practice that brings with it a bunch of benefits outside the scope of this quick discussion of routing.</p>
</div>
<p>React does not assume you have any routing to do, it does not ship with an inbuilt router, so we’ll need to import one ourselves. Use NPM to install <code class="docutils literal notranslate"><span class="pre">react-router-dom</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>install<span class="w"> </span>--save<span class="w"> </span>react-router-dom
</pre></div>
</div>
<p>Then let’s configure the required routing. We’ll assume that we have a number of pages already implemented as containers <code class="docutils literal notranslate"><span class="pre">Vote</span></code>, <code class="docutils literal notranslate"><span class="pre">Verdict</span></code>, <code class="docutils literal notranslate"><span class="pre">Votes</span></code> and <code class="docutils literal notranslate"><span class="pre">Home</span></code>.</p>
<p>To keep things organised well implement our routes as a separate component</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">BrowserRouter</span><span class="p">,</span><span class="w"> </span><span class="nx">Routes</span><span class="p">,</span><span class="w"> </span><span class="nx">Route</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-router-dom&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Home</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./containers/Home&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Vote</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./containers/Vote&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Verdict</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./containers/Verdict&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Votes</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./containers/Votes&#39;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">AppRoutes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">BrowserRouter</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">Routes</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">Route</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;vote&quot;</span> <span class="na">element</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Vote</span> <span class="p">/&gt;}</span> <span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">Route</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;admin/votes&quot;</span> <span class="na">element</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Votes</span> <span class="p">/&gt;}</span> <span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">Route</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;verdict&quot;</span> <span class="na">element</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Verdict</span> <span class="p">/&gt;}</span> <span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">Route</span> <span class="na">path</span><span class="o">=</span><span class="s">&quot;*&quot;</span> <span class="na">element</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Home</span> <span class="p">/&gt;}</span> <span class="p">/&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">Routes</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">BrowserRouter</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">AppRoutes</span><span class="p">;</span>
</pre></div>
</div>
<p>The router is rather simple:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BrowserRouter</span></code> and <code class="docutils literal notranslate"><span class="pre">Routes</span></code> components will handle all the routing for us, they load components (pages) in according to a URL</p></li>
<li><p>we can declare the routing we require by adding <code class="docutils literal notranslate"><span class="pre">Route</span></code> components that bind one of our pages (<code class="docutils literal notranslate"><span class="pre">Vote</span></code>, <code class="docutils literal notranslate"><span class="pre">Votes</span></code>, etc) to a particular path</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Route</span></code>s are evaluated in order, which is worth remembering when declaring more complex routing rules</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">path</span></code> attribute follows a particular syntax that you should spend some time understanding, note here that we provide a path with wildcard value <code class="docutils literal notranslate"><span class="pre">*</span></code>, which acts as a catch-all that directs users to the home page if they stray from the other three defined routes.</p></li>
</ol>
<p>Finally we need to register our routes with the application, our new App now looks like:</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="s1">&#39;./App.css&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">Routes</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Routes&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">ApiProvider</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./contexts/ApiProvider&#39;</span><span class="p">;</span>
<span class="w">  </span>
<span class="kd">function</span><span class="w"> </span><span class="nx">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;App&quot;</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">header</span> <span class="na">className</span><span class="o">=</span><span class="s">&quot;App-header&quot;</span><span class="p">&gt;</span>
<span class="w">                </span><span class="p">&lt;</span><span class="nt">ApiProvider</span><span class="p">&gt;</span>
<span class="w">                    </span><span class="p">&lt;</span><span class="nt">Routes</span> <span class="p">/&gt;</span>
<span class="w">                </span><span class="p">&lt;/</span><span class="nt">ApiProvider</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">header</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">App</span><span class="p">;</span>
</pre></div>
</div>
<p>By now we should have some routes working, and if you were to provide some simple implementation for each of the <code class="docutils literal notranslate"><span class="pre">Vote</span></code>, <code class="docutils literal notranslate"><span class="pre">Votes</span></code>, <code class="docutils literal notranslate"><span class="pre">Verdict</span></code> and <code class="docutils literal notranslate"><span class="pre">Home</span></code> containers you would be able to visit each by forcefully browsing to its respective route. For some use cases we’d like the application to control the navigation for the user, for example by displaying the verdict after a user submits a vote. We can use the <code class="docutils literal notranslate"><span class="pre">useNavigation</span></code> hook for this purpose, a simple, stripped down version of a redirect from the vote page to the verdict looks like:</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useNavigate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react-router-dom&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Vote</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">navigate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useNavigate</span><span class="p">();</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handleVoteSubmitted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">voteValue</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// send vote to api</span>
<span class="w">        </span><span class="nx">navigate</span><span class="p">(</span><span class="s1">&#39;/verdict&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="c1">// some beautiful JSX, which binds handleVoteSubmitted to a vote form</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-useeffect-hook">
<h3>The <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook<a class="headerlink" href="#the-useeffect-hook" title="Permalink to this heading">#</a></h3>
<p>We’re very close to done with the functional side of our application, we have an API client, appropriately available where its needed via a Context, and some basic routing configured. The final element that requires some attention is how to fetch data from the API when a component is mounted to the DOM. In previous milestones we leant how to fetch data in response to a user action - such as clicking a button. However, for some use cases we’d prefer that data be fetched automatically - it would be ridiculous, for example, to require users that navigate to the verdict page to also click a <em>fetch votes</em> button.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook is used to when we need to synchronise our component with an external system (such as by fetching data from that external system). The <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook is triggered when the component is mounted to the DOM, or when any of its dependencies are modified. We’ll take a look at a stripped down version of the <code class="docutils literal notranslate"><span class="pre">Verdict</span></code> component to understand how it’s used in this application.</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useState</span><span class="p">,</span><span class="w"> </span><span class="nx">useEffect</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">useApi</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../contexts/ApiProvider&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Verdict</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">api</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useApi</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">verdict</span><span class="p">,</span><span class="w"> </span><span class="nx">setVerdict</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">({</span>
<span class="w">        </span><span class="nx">supporting</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">opposing</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;?&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">loaded</span><span class="p">,</span><span class="w"> </span><span class="nx">setLoaded</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">setError</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">useState</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">useEffect</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AbortController</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">signal</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">controller</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">doFetch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">setVerdict</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">api</span><span class="p">.</span><span class="nx">getVerdict</span><span class="p">(</span><span class="nx">signal</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;AbortError&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">setError</span><span class="p">(</span><span class="sb">`ouch! we tried to fetch the votes but ended up fetching this error instead: </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">setLoaded</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="nx">doFetch</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="c1">// some beautiful JSX that renders the verdict using data fetched from the API</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is a fair amount happening here:</p>
<ol class="arabic simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">Verdict</span></code> container naturally requires access to the API client via <code class="docutils literal notranslate"><span class="pre">useApi</span></code></p></li>
<li><p>additionally the we make use of the <code class="docutils literal notranslate"><span class="pre">useState</span></code> hook to capture the verdict data, as well as implement some error handling</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">useEffect</span></code> takes two arguments, a function that performs synchronisation with the external system, and a list of dependencies. We only need to fetch the verdict when the component is mounted so we’ll indicate to the hook that it has no dependencies (and shouldn’t be re-triggered on re-renders) by providing an empty list</p></li>
<li><p>our synchronisation function performs a number of key actions, it tries to fetch data from the API (via the API client), if this fails it sets an error on the container, and - finally - sets the <code class="docutils literal notranslate"><span class="pre">loaded</span></code> state, which signals to React that the component should be re-rendered (to display either the verdict or caught error)</p></li>
<li><p>the synchronisation function must be synchronous, so we introduce the <code class="docutils literal notranslate"><span class="pre">doFetch</span></code> function to handle the asynchronous processing of the API request.</p></li>
<li><p>it’s best practice for the synchronisation function to return a <em>clean up</em> function. This function is called when the component is unmounted from the DOM, and provides a means by which we can remove any event listeners we may have registered, cancel any scheduled timeouts or intervals, or - in our case - abort any inflight requests to external systems. We’ll make use of the <code class="docutils literal notranslate"><span class="pre">AbortController</span></code> to manage our clean up; the controller’s signal object is passed to the API client (which in turn provides it to <code class="docutils literal notranslate"><span class="pre">fetch</span></code>) and we provide the controller’s <code class="docutils literal notranslate"><span class="pre">abort</span></code> method as the return of our synchronisation function.</p></li>
</ol>
</section>
<section id="css-modules">
<h3>CSS Modules<a class="headerlink" href="#css-modules" title="Permalink to this heading">#</a></h3>
<p>Before we wrap up extending the UI we’ll spend a few moments to understand how CSS Modules have been used to manage styling in this project. The primary objective of CSS Modules is to provide a way to <em>scope</em> styles to a particular component, which helps avoid managing all styling within one massive complicated stylesheet. To use CSS Modules, you simply declare your styles within a file with extension <code class="docutils literal notranslate"><span class="pre">.module.css</span></code>, and then apply those styles to the markup of a component by importing it - like any other JS module - and binding it to the elements you wish to style. Take a quick look at the <code class="docutils literal notranslate"><span class="pre">Card.module.css</span></code> CSS Module which is used to style the <code class="docutils literal notranslate"><span class="pre">Card</span></code> component.</p>
<div class="highlight-css notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="nc">Card</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">left</span><span class="p">;</span>
<span class="w">    </span><span class="k">display</span><span class="p">:</span><span class="w"> </span><span class="kc">inline-block</span><span class="p">;</span>
<span class="w">    </span><span class="k">min-width</span><span class="p">:</span><span class="w"> </span><span class="mi">110</span><span class="kt">px</span><span class="p">;</span>
<span class="w">    </span><span class="c">/* other directives */</span>
<span class="p">}</span>


<span class="p">.</span><span class="nc">Card</span><span class="w"> </span><span class="nt">hr</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="nf">var</span><span class="p">(</span><span class="nv">--color-secondary</span><span class="p">);</span>
<span class="w">    </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="n">px</span><span class="p">;</span>
<span class="p">}</span>

<span class="c">/* additional styles */</span>
</pre></div>
</div>
<p>If you’ve got some experience with CSS then the code above should look familiar, it really is just simple CSS.</p>
<div class="highlight-jsx notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nx">React</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;react&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">styles</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./Card.module.css&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">Card</span><span class="p">({</span><span class="w"> </span><span class="nx">title</span><span class="p">,</span><span class="w"> </span><span class="nx">subtitle</span><span class="p">,</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">Card</span><span class="p">}&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">CardTitle</span><span class="p">}&gt;{</span><span class="nx">title</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">            </span><span class="p">{(</span><span class="nx">subtitle</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">CardSubtitle</span><span class="p">}&gt;{</span><span class="nx">subtitle</span><span class="p">}&lt;/</span><span class="nt">div</span><span class="p">&gt;)}</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
<span class="w">            </span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">styles</span><span class="p">.</span><span class="nx">CardContent</span><span class="p">}&gt;</span>
<span class="w">                </span><span class="p">{</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We import CSS Modules in the same way we would import any other JS module or component, and bind our styles via the <code class="docutils literal notranslate"><span class="pre">className</span></code> attribute of elements.</p>
</section>
</section>
<section id="deployment-again">
<h2>Deployment, again<a class="headerlink" href="#deployment-again" title="Permalink to this heading">#</a></h2>
<section id="database">
<h3>Database<a class="headerlink" href="#database" title="Permalink to this heading">#</a></h3>
<p>If you’ve not done so already (because, for example, you’ve been developing against a local database), you will need to update the schema of the Render managed database. Run - in order - scripts <code class="docutils literal notranslate"><span class="pre">drop.sql</span></code>, <code class="docutils literal notranslate"><span class="pre">init.sql</span></code> and <code class="docutils literal notranslate"><span class="pre">load.sql</span></code> against the database, as demonstrated in previous milestones.</p>
</section>
<section id="api-and-ui">
<h3>API and UI<a class="headerlink" href="#api-and-ui" title="Permalink to this heading">#</a></h3>
<p>You should already have a Render Web Service and Static Site setup for the API and UI, respectively. Committing and pushing the code contributed by this milestone to your GitHub repository should be enough to trigger Render to build and deploy your new system (thank you, <em>Continuous Deployment</em> 🥳); however, if you’ve disabled automated deployment from GitHub, then you will need manually trigger deployment after your changes have been committed and pushed to the deployment branch.</p>
<p>Once your’ve deployed your latest changes, checkout the UI, the home page should look something like this:</p>
<p><img alt="home page" src="../_images/home-page.png" /></p>
<p>Try navigating away from the home page by clicking on <em>take me to the votes</em> and then refreshing the page, you will notice something odd happen. The server will respond with the message <em>Not Found</em>, which is not entirely the behaviour we’re after.</p>
<p><img alt="not found page" src="../_images/not-found.png" /></p>
<p>The reason for this is that on a refresh the client makes a request to Render Static Site to fetch a verdict document, but of course this document doesn’t exist and so the Render serves a <em>Not Found</em> message instead. We can fix this by creating a Rewrite Rule. Open the Render Dashboard, select your Static Site, then <em>Redirects/Rewrites</em>, and add the following rule.</p>
<p><img alt="rewrite config" src="../_images/configure-rewrite.png" /></p>
<p>Now try refreshing the verdict page, the server should respond with the application’s <code class="docutils literal notranslate"><span class="pre">index.html</span></code> and our application should, in turn, navigate you to the verdict page, as expected.</p>
<p>Congratulations you have a voting application with all it’s core functionality implemented, and deployed to Render. In the next milestone we’ll start locking down some of the privileged actions by implementing authentication and authorization for administrator users.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./react-example"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="swen90007-react-example-primer-milestone-1.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Milestone 1: Deployment</p>
      </div>
    </a>
    <a class="right-next"
       href="swen90007-react-example-primer-milestone-3.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Milestone 3: Authentication</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#database-schema-changes">Database schema changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-changes">API changes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#working-with-json">Working with JSON</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simple-domain">A simple domain</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-layer">Data layer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#api-layer-and-servlets">API layer and Servlets</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#some-house-keeping">Some house keeping</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-utilities">A few utilities</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#servlet-context">Servlet Context</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-servlets-finally">The Servlets, finally</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#security-updates">Security updates</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cors">CORS</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-site-request-forgery-csrf">Cross Site Request Forgery (CSRF)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-the-api-with-httpie">Verifying the API with HTTPie</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#verdict">/verdict</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#vote">/vote</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#manage-vote">/manage/vote</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extending-the-ui">Extending the UI</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#an-api-client">An API client</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managing-state-with-react-contexts">Managing state with React Contexts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-pages">Routing pages</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-useeffect-hook">The <code class="docutils literal notranslate"><span class="pre">useEffect</span></code> hook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#css-modules">CSS Modules</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-again">Deployment, again</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#database">Database</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#api-and-ui">API and UI</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By School of Computing and Information Systems, The University of Melbourne
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>